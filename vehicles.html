<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JKCar Management - ì°¨ëŸ‰ê´€ë¦¬</title>
  <?!= include('styles'); ?>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="container">
      <div class="header-content">
        <a href="?page=home" class="logo">
          ğŸš— JKCar Management
        </a>
        <nav class="nav">
          <a href="?page=dashboard" class="nav-link">ğŸ“Š ëŒ€ì‹œë³´ë“œ</a>
          <a href="?page=vehicles" class="nav-link active">ğŸš— ì°¨ëŸ‰ê´€ë¦¬</a>
          <a href="?page=accidents" class="nav-link">ğŸ“ ì‚¬ê³ ê´€ë¦¬</a>
          <a href="?page=maintenance" class="nav-link">ğŸ”§ ì •ë¹„ê´€ë¦¬</a>
          <a href="?page=profile" class="nav-link">ğŸ‘¤ í”„ë¡œí•„</a>
        </nav>
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()">â˜°</button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main">
    <div class="container">
      <!-- Page Header -->
      <section class="page-header mb-6">
        <div class="card">
          <div class="page-header-content">
            <div class="page-header-text">
              <h1>ğŸš— ì°¨ëŸ‰ ê´€ë¦¬</h1>
              <p>ë“±ë¡ëœ ì°¨ëŸ‰ë“¤ì„ ê´€ë¦¬í•˜ê³  ìƒˆë¡œìš´ ì°¨ëŸ‰ì„ ë“±ë¡í•˜ì„¸ìš”.</p>
            </div>
            <div class="page-header-actions">
              <button class="btn btn-primary" onclick="showAddVehicleModal()">
                ğŸš— ìƒˆ ì°¨ëŸ‰ ë“±ë¡
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Search and Filter -->
      <section class="search-filter mb-6">
        <div class="card">
          <div class="search-filter-content">
            <div class="search-box">
              <input type="text" id="search-vehicles" class="form-input" placeholder="ì°¨ëŸ‰ ê²€ìƒ‰ (ë²ˆí˜¸íŒ, ì œì¡°ì‚¬, ëª¨ë¸)">
            </div>
            <div class="filter-options">
              <select id="filter-status" class="form-input">
                <option value="">ëª¨ë“  ìƒíƒœ</option>
                <option value="ok">ì •ìƒ</option>
                <option value="warning">ë§Œë£Œ ì˜ˆì •</option>
                <option value="expired">ë§Œë£Œë¨</option>
              </select>
              <select id="filter-fuel" class="form-input">
                <option value="">ëª¨ë“  ì—°ë£Œ</option>
                <option value="Petrol">Petrol</option>
                <option value="Diesel">Diesel</option>
                <option value="Electric">Electric</option>
                <option value="Hybrid">Hybrid</option>
              </select>
            </div>
          </div>
        </div>
      </section>

      <!-- Vehicles List -->
      <section class="vehicles-list">
        <div id="vehicles-container" class="grid grid-3">
          <!-- ì°¨ëŸ‰ ëª©ë¡ì´ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ -->
        </div>
      </section>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <p>&copy; 2024 JKCar Management. All rights reserved.</p>
    </div>
  </footer>

  <?!= include('script'); ?>

  <script>
  // ì°¨ëŸ‰ ê²€ìƒ‰ ë° í•„í„°ë§
  function filterVehicles() {
    const searchTerm = document.getElementById('search-vehicles').value.toLowerCase();
    const statusFilter = document.getElementById('filter-status').value;
    const fuelFilter = document.getElementById('filter-fuel').value;

    const filteredVehicles = vehicles.filter(vehicle => {
      // ê²€ìƒ‰ì–´ í•„í„°
      const matchesSearch = 
        vehicle.plateNumber.toLowerCase().includes(searchTerm) ||
        vehicle.make.toLowerCase().includes(searchTerm) ||
        vehicle.model.toLowerCase().includes(searchTerm);

      // ìƒíƒœ í•„í„°
      let matchesStatus = true;
      if (statusFilter) {
        const today = new Date();
        const regoExpiry = vehicle.regoExpiry ? new Date(vehicle.regoExpiry) : null;
        const insuranceExpiry = vehicle.insuranceExpiry ? new Date(vehicle.insuranceExpiry) : null;
        const greenSlipExpiry = vehicle.greenSlipExpiry ? new Date(vehicle.greenSlipExpiry) : null;
        
        const hasExpiring = (regoExpiry && regoExpiry - today <= 30 * 24 * 60 * 60 * 1000) ||
                           (insuranceExpiry && insuranceExpiry - today <= 30 * 24 * 60 * 60 * 1000) ||
                           (greenSlipExpiry && greenSlipExpiry - today <= 30 * 24 * 60 * 60 * 1000);
        
        const hasExpired = (regoExpiry && regoExpiry - today <= 0) ||
                          (insuranceExpiry && insuranceExpiry - today <= 0) ||
                          (greenSlipExpiry && greenSlipExpiry - today <= 0);

        if (statusFilter === 'ok') {
          matchesStatus = !hasExpiring && !hasExpired;
        } else if (statusFilter === 'warning') {
          matchesStatus = hasExpiring && !hasExpired;
        } else if (statusFilter === 'expired') {
          matchesStatus = hasExpired;
        }
      }

      // ì—°ë£Œ í•„í„°
      const matchesFuel = !fuelFilter || vehicle.fuelType === fuelFilter;

      return matchesSearch && matchesStatus && matchesFuel;
    });

    renderFilteredVehicles(filteredVehicles);
  }

  // í•„í„°ë§ëœ ì°¨ëŸ‰ ë Œë”ë§
  function renderFilteredVehicles(filteredVehicles) {
    const container = document.getElementById('vehicles-container');
    if (!container) return;

    if (filteredVehicles.length === 0) {
      container.innerHTML = `
        <div class="card text-center" style="grid-column: 1 / -1;">
          <div class="mb-4">ğŸ”</div>
          <h3>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
          <p class="text-gray-600 mb-4">ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë‚˜ í•„í„°ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”.</p>
          <button class="btn btn-secondary" onclick="clearFilters()">
            í•„í„° ì´ˆê¸°í™”
          </button>
        </div>
      `;
      return;
    }

    container.innerHTML = filteredVehicles.map(vehicle => `
      <div class="vehicle-card fade-in">
        <div class="vehicle-image">
          ğŸš—
        </div>
        <div class="vehicle-info">
          <div class="vehicle-plate">${vehicle.plateNumber}</div>
          <div class="vehicle-details">
            <div>${vehicle.make} ${vehicle.model} (${vehicle.year})</div>
            <div>${vehicle.color} â€¢ ${vehicle.fuelType}</div>
          </div>
          <div class="vehicle-status">
            ${getExpiryStatus(vehicle.regoExpiry, 'Rego')}
            ${getExpiryStatus(vehicle.insuranceExpiry, 'ë³´í—˜')}
            ${getExpiryStatus(vehicle.greenSlipExpiry, 'Green Slip')}
          </div>
          <div class="vehicle-actions mt-4">
            <button class="btn btn-sm btn-secondary" onclick="editVehicle('${vehicle.id}')">
              âœï¸ ìˆ˜ì •
            </button>
            <button class="btn btn-sm btn-error" onclick="deleteVehicle('${vehicle.id}')">
              ğŸ—‘ï¸ ì‚­ì œ
            </button>
            <button class="btn btn-sm btn-primary" onclick="viewVehicleDetails('${vehicle.id}')">
              ğŸ‘ï¸ ìƒì„¸ë³´ê¸°
            </button>
          </div>
        </div>
      </div>
    `).join('');
  }

  // í•„í„° ì´ˆê¸°í™”
  function clearFilters() {
    document.getElementById('search-vehicles').value = '';
    document.getElementById('filter-status').value = '';
    document.getElementById('filter-fuel').value = '';
    renderVehicles();
  }

  // ì°¨ëŸ‰ ìˆ˜ì •
  function editVehicle(vehicleId) {
    const vehicle = vehicles.find(v => v.id === vehicleId);
    if (!vehicle) {
      showAlert('ì°¨ëŸ‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
      return;
    }

    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
      <div class="modal-content">
        <div class="modal-header">
          <h2>âœï¸ ì°¨ëŸ‰ ì •ë³´ ìˆ˜ì •</h2>
          <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
          <form id="edit-vehicle-form">
            <div class="grid grid-2">
              <div class="form-group">
                <label for="edit-plateNumber" class="form-label">ë²ˆí˜¸íŒ *</label>
                <input type="text" id="edit-plateNumber" class="form-input" value="${vehicle.plateNumber}" required>
              </div>
              <div class="form-group">
                <label for="edit-make" class="form-label">ì œì¡°ì‚¬ *</label>
                <input type="text" id="edit-make" class="form-input" value="${vehicle.make}" required>
              </div>
              <div class="form-group">
                <label for="edit-model" class="form-label">ëª¨ë¸ *</label>
                <input type="text" id="edit-model" class="form-input" value="${vehicle.model}" required>
              </div>
              <div class="form-group">
                <label for="edit-year" class="form-label">ì—°ë„ *</label>
                <input type="number" id="edit-year" class="form-input" value="${vehicle.year}" min="1900" max="2030" required>
              </div>
              <div class="form-group">
                <label for="edit-color" class="form-label">ìƒ‰ìƒ</label>
                <input type="text" id="edit-color" class="form-input" value="${vehicle.color || ''}">
              </div>
              <div class="form-group">
                <label for="edit-fuelType" class="form-label">ì—°ë£Œ íƒ€ì…</label>
                <select id="edit-fuelType" class="form-input">
                  <option value="Petrol" ${vehicle.fuelType === 'Petrol' ? 'selected' : ''}>Petrol</option>
                  <option value="Diesel" ${vehicle.fuelType === 'Diesel' ? 'selected' : ''}>Diesel</option>
                  <option value="Electric" ${vehicle.fuelType === 'Electric' ? 'selected' : ''}>Electric</option>
                  <option value="Hybrid" ${vehicle.fuelType === 'Hybrid' ? 'selected' : ''}>Hybrid</option>
                </select>
              </div>
              <div class="form-group">
                <label for="edit-regoExpiry" class="form-label">Rego ë§Œë£Œì¼</label>
                <input type="date" id="edit-regoExpiry" class="form-input" value="${vehicle.regoExpiry || ''}">
              </div>
              <div class="form-group">
                <label for="edit-insuranceExpiry" class="form-label">ë³´í—˜ ë§Œë£Œì¼</label>
                <input type="date" id="edit-insuranceExpiry" class="form-input" value="${vehicle.insuranceExpiry || ''}">
              </div>
              <div class="form-group">
                <label for="edit-greenSlipExpiry" class="form-label">Green Slip ë§Œë£Œì¼</label>
                <input type="date" id="edit-greenSlipExpiry" class="form-input" value="${vehicle.greenSlipExpiry || ''}">
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button class="btn btn-primary" onclick="updateVehicle('${vehicleId}')">
            <span class="loading hidden"></span>
            ìˆ˜ì •í•˜ê¸°
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }

  // ì°¨ëŸ‰ ì •ë³´ ì—…ë°ì´íŠ¸
  function updateVehicle(vehicleId) {
    const vehicleData = {
      plateNumber: document.getElementById('edit-plateNumber').value,
      make: document.getElementById('edit-make').value,
      model: document.getElementById('edit-model').value,
      year: document.getElementById('edit-year').value,
      color: document.getElementById('edit-color').value,
      fuelType: document.getElementById('edit-fuelType').value,
      regoExpiry: document.getElementById('edit-regoExpiry').value,
      insuranceExpiry: document.getElementById('edit-insuranceExpiry').value,
      greenSlipExpiry: document.getElementById('edit-greenSlipExpiry').value
    };

    if (!vehicleData.plateNumber || !vehicleData.make || !vehicleData.model || !vehicleData.year) {
      showAlert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
      return;
    }

    const button = document.querySelector('.modal-footer .btn-primary');
    const loading = button.querySelector('.loading');
    
    button.disabled = true;
    loading.classList.remove('hidden');

    // ì‹¤ì œë¡œëŠ” Firebaseì—ì„œ ì—…ë°ì´íŠ¸
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          showAlert('ì°¨ëŸ‰ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤! âœ…', 'success');
          closeModal();
          loadVehicles();
        } else {
          showAlert(result.message, 'error');
        }
      })
      .withFailureHandler(function(error) {
        showAlert('ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
      })
      .withFinally(function() {
        button.disabled = false;
        loading.classList.add('hidden');
      })
      .updateVehicle(vehicleId, vehicleData);
  }

  // ì°¨ëŸ‰ ì‚­ì œ
  function deleteVehicle(vehicleId) {
    if (confirm('ì •ë§ë¡œ ì´ ì°¨ëŸ‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showAlert('ì°¨ëŸ‰ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            loadVehicles();
          } else {
            showAlert(result.message, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showAlert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        })
        .deleteVehicle(vehicleId);
    }
  }

  // ì°¨ëŸ‰ ìƒì„¸ë³´ê¸°
  function viewVehicleDetails(vehicleId) {
    const vehicle = vehicles.find(v => v.id === vehicleId);
    if (!vehicle) {
      showAlert('ì°¨ëŸ‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
      return;
    }

    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
      <div class="modal-content">
        <div class="modal-header">
          <h2>ğŸš— ì°¨ëŸ‰ ìƒì„¸ì •ë³´</h2>
          <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div class="vehicle-detail-grid">
            <div class="detail-section">
              <h3>ê¸°ë³¸ ì •ë³´</h3>
              <div class="detail-item">
                <span class="detail-label">ë²ˆí˜¸íŒ:</span>
                <span class="detail-value">${vehicle.plateNumber}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">ì œì¡°ì‚¬:</span>
                <span class="detail-value">${vehicle.make}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">ëª¨ë¸:</span>
                <span class="detail-value">${vehicle.model}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">ì—°ë„:</span>
                <span class="detail-value">${vehicle.year}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">ìƒ‰ìƒ:</span>
                <span class="detail-value">${vehicle.color || 'ë¯¸ì…ë ¥'}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">ì—°ë£Œ:</span>
                <span class="detail-value">${vehicle.fuelType}</span>
              </div>
            </div>
            <div class="detail-section">
              <h3>ë§Œë£Œì¼ ì •ë³´</h3>
              <div class="detail-item">
                <span class="detail-label">Rego:</span>
                <span class="detail-value ${getExpiryClass(vehicle.regoExpiry)}">
                  ${vehicle.regoExpiry ? formatDate(vehicle.regoExpiry) : 'ë¯¸ì…ë ¥'}
                </span>
              </div>
              <div class="detail-item">
                <span class="detail-label">ë³´í—˜:</span>
                <span class="detail-value ${getExpiryClass(vehicle.insuranceExpiry)}">
                  ${vehicle.insuranceExpiry ? formatDate(vehicle.insuranceExpiry) : 'ë¯¸ì…ë ¥'}
                </span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Green Slip:</span>
                <span class="detail-value ${getExpiryClass(vehicle.greenSlipExpiry)}">
                  ${vehicle.greenSlipExpiry ? formatDate(vehicle.greenSlipExpiry) : 'ë¯¸ì…ë ¥'}
                </span>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
          <button class="btn btn-primary" onclick="editVehicle('${vehicleId}')">ìˆ˜ì •í•˜ê¸°</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }

  // ë§Œë£Œì¼ í´ë˜ìŠ¤ ë°˜í™˜
  function getExpiryClass(expiryDate) {
    if (!expiryDate) return '';
    
    const today = new Date();
    const expiry = new Date(expiryDate);
    const daysUntilExpiry = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
    
    if (daysUntilExpiry <= 0) return 'text-error';
    if (daysUntilExpiry <= 30) return 'text-warning';
    return 'text-success';
  }

  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
  document.addEventListener('DOMContentLoaded', function() {
    // ê²€ìƒ‰ ë° í•„í„° ì´ë²¤íŠ¸
    document.getElementById('search-vehicles').addEventListener('input', filterVehicles);
    document.getElementById('filter-status').addEventListener('change', filterVehicles);
    document.getElementById('filter-fuel').addEventListener('change', filterVehicles);
  });
  </script>

  <style>
  /* Page Header */
  .page-header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 2rem;
  }

  .page-header-text h1 {
    font-size: 2rem;
    font-weight: 700;
    color: var(--gray-800);
    margin-bottom: 0.5rem;
  }

  .page-header-text p {
    color: var(--gray-600);
    font-size: 1.1rem;
  }

  /* Search and Filter */
  .search-filter-content {
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
  }

  .search-box {
    flex: 1;
    min-width: 250px;
  }

  .filter-options {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .filter-options select {
    min-width: 120px;
  }

  /* Vehicle Actions */
  .vehicle-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  /* Vehicle Detail Grid */
  .vehicle-detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
  }

  .detail-section h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--gray-800);
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--light-blue);
  }

  .detail-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--gray-200);
  }

  .detail-item:last-child {
    border-bottom: none;
  }

  .detail-label {
    font-weight: 500;
    color: var(--gray-700);
  }

  .detail-value {
    color: var(--gray-800);
    font-weight: 600;
  }

  .text-success {
    color: var(--success);
  }

  .text-warning {
    color: var(--warning);
  }

  .text-error {
    color: var(--error);
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .page-header-content {
      flex-direction: column;
      text-align: center;
    }

    .search-filter-content {
      flex-direction: column;
      align-items: stretch;
    }

    .filter-options {
      justify-content: center;
    }

    .vehicle-detail-grid {
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    .vehicle-actions {
      justify-content: center;
    }
  }
  </style>
</body>
</html> 