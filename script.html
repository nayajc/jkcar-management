<script type="module">
// Firebase SDK ì„í¬íŠ¸
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
import { getDatabase, ref, set, get, push, update, remove } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";
import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js";

// Firebase ì„¤ì •
const firebaseConfig = {
  apiKey: "AIzaSyA-BYaIUXgk8szUEuwdmqf8xXdzr8Ss2cs",
  authDomain: "jkcar-management.firebaseapp.com",
  databaseURL: "https://jkcar-management-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "jkcar-management",
  storageBucket: "jkcar-management.firebasestorage.app",
  messagingSenderId: "158717054066",
  appId: "1:158717054066:web:c42faad070cde9911d06eb",
  measurementId: "G-3WRFDYEP1T"
};

// Firebase ì´ˆê¸°í™”
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const storage = getStorage(app);

// ì „ì—­ ë³€ìˆ˜
let currentUser = null;
let vehicles = [];
let accidents = [];
let maintenance = [];

// Firebase ì´ˆê¸°í™”
function initializeFirebase() {
  console.log('Firebase ì´ˆê¸°í™”ë¨');
  
  // ì¸ì¦ ìƒíƒœ ë³€ê²½ ê°ì§€
  auth.onAuthStateChanged(function(user) {
    if (user) {
      currentUser = user;
      console.log('ì‚¬ìš©ì ë¡œê·¸ì¸:', user.email);
      loadUserProfile();
    } else {
      console.log('ì‚¬ìš©ì ë¡œê·¸ì•„ì›ƒ');
      currentUser = null;
      // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
      if (window.location.search.indexOf('page=login') === -1) {
        window.location.href = '?page=login';
      }
    }
  });
}

// ì‚¬ìš©ì ì¸ì¦ ìƒíƒœ í™•ì¸
function checkAuthStatus() {
  // Firebase Authë¥¼ í†µí•´ ì‚¬ìš©ì ì •ë³´ í™•ì¸
  if (auth.currentUser) {
    currentUser = auth.currentUser;
    loadUserProfile();
  } else {
    // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    window.location.href = '?page=login';
  }
}

// ì‚¬ìš©ì í”„ë¡œí•„ ë¡œë“œ
async function loadUserProfile() {
  if (!currentUser) return;
  
  try {
    const userRef = ref(db, `users/${currentUser.uid}`);
    const snapshot = await get(userRef);
    
    if (snapshot.exists()) {
      const profile = snapshot.val();
      updateProfileUI(profile);
    } else {
      // ìµœì´ˆ ì ‘ì†ì‹œ ë³„ëª… ì…ë ¥ ëª¨ë‹¬ í‘œì‹œ
      showNicknameModal();
    }
  } catch (error) {
    console.error('í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨:', error);
  }
}

// ë³„ëª… ì…ë ¥ ëª¨ë‹¬ í‘œì‹œ
function showNicknameModal() {
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h2>ğŸ‰ í™˜ì˜í•©ë‹ˆë‹¤!</h2>
        <p>JKCar Management ì•±ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ë³„ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="nickname" class="form-label">ë³„ëª…</label>
          <input type="text" id="nickname" class="form-input" placeholder="ì˜ˆ: ì°¨ëŸ‰ê´€ë¦¬ì™•" maxlength="20">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="saveNickname()">
          <span class="loading hidden"></span>
          ì €ì¥í•˜ê¸°
        </button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

// ë³„ëª… ì €ì¥
async function saveNickname() {
  const nickname = document.getElementById('nickname').value.trim();
  if (!nickname) {
    showAlert('ë³„ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
    return;
  }

  const button = document.querySelector('.modal-footer .btn');
  const loading = button.querySelector('.loading');
  
  button.disabled = true;
  loading.classList.remove('hidden');

  try {
    const userData = {
      email: currentUser.email,
      nickname: nickname,
      createdAt: new Date().toISOString(),
      lastLogin: new Date().toISOString()
    };

    const userRef = ref(db, `users/${currentUser.uid}`);
    await set(userRef, userData);
    
    showAlert('í”„ë¡œí•„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰', 'success');
    document.querySelector('.modal-overlay').remove();
    loadUserProfile();
  } catch (error) {
    console.error('í”„ë¡œí•„ ì €ì¥ ì‹¤íŒ¨:', error);
    showAlert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
  } finally {
    button.disabled = false;
    loading.classList.add('hidden');
  }
}

// í”„ë¡œí•„ UI ì—…ë°ì´íŠ¸
function updateProfileUI(profile) {
  const profileElements = document.querySelectorAll('.user-nickname');
  profileElements.forEach(element => {
    element.textContent = profile.nickname;
  });
}

// ì°¨ëŸ‰ ëª©ë¡ ë¡œë“œ
async function loadVehicles() {
  if (!currentUser) return;
  
  try {
    const vehiclesRef = ref(db, `vehicles/${currentUser.uid}`);
    const snapshot = await get(vehiclesRef);
    
    if (snapshot.exists()) {
      vehicles = Object.values(snapshot.val());
    } else {
      vehicles = [];
    }
    
    renderVehicles();
    updateDashboardStats();
  } catch (error) {
    console.error('ì°¨ëŸ‰ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
    showAlert('ì°¨ëŸ‰ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
  }
}

// ì°¨ëŸ‰ ëª©ë¡ ë Œë”ë§
function renderVehicles() {
  const container = document.getElementById('vehicles-container');
  if (!container) return;

  if (vehicles.length === 0) {
    container.innerHTML = `
      <div class="card text-center">
        <div class="mb-4">ğŸš—</div>
        <h3>ë“±ë¡ëœ ì°¨ëŸ‰ì´ ì—†ìŠµë‹ˆë‹¤</h3>
        <p class="text-gray-600 mb-4">ì²« ë²ˆì§¸ ì°¨ëŸ‰ì„ ë“±ë¡í•´ë³´ì„¸ìš”!</p>
        <button class="btn btn-primary" onclick="showAddVehicleModal()">
          ì°¨ëŸ‰ ë“±ë¡í•˜ê¸°
        </button>
      </div>
    `;
    return;
  }

  container.innerHTML = vehicles.map(vehicle => `
    <div class="vehicle-card fade-in">
      <div class="vehicle-image">
        ğŸš—
      </div>
      <div class="vehicle-info">
        <div class="vehicle-plate">${vehicle.plateNumber}</div>
        <div class="vehicle-details">
          <div>${vehicle.make} ${vehicle.model} (${vehicle.year})</div>
          <div>${vehicle.color} â€¢ ${vehicle.fuelType}</div>
        </div>
        <div class="vehicle-status">
          ${getExpiryStatus(vehicle.regoExpiry, 'Rego')}
          ${getExpiryStatus(vehicle.insuranceExpiry, 'ë³´í—˜')}
          ${getExpiryStatus(vehicle.greenSlipExpiry, 'Green Slip')}
        </div>
        <div class="mt-4 flex gap-2">
          <button class="btn btn-sm btn-secondary" onclick="editVehicle('${vehicle.id}')">
            ìˆ˜ì •
          </button>
          <button class="btn btn-sm btn-error" onclick="deleteVehicle('${vehicle.id}')">
            ì‚­ì œ
          </button>
        </div>
      </div>
    </div>
  `).join('');
}

// ë§Œë£Œì¼ ìƒíƒœ í™•ì¸
function getExpiryStatus(expiryDate, label) {
  if (!expiryDate) return '';
  
  const today = new Date();
  const expiry = new Date(expiryDate);
  const daysUntilExpiry = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
  
  let statusClass = 'status-ok';
  let statusText = `${label} ì •ìƒ`;
  
  if (daysUntilExpiry <= 0) {
    statusClass = 'status-error';
    statusText = `${label} ë§Œë£Œ`;
  } else if (daysUntilExpiry <= 30) {
    statusClass = 'status-warning';
    statusText = `${label} ${daysUntilExpiry}ì¼`;
  }
  
  return `<span class="status-badge ${statusClass}">${statusText}</span>`;
}

// ì°¨ëŸ‰ ë“±ë¡ ëª¨ë‹¬ í‘œì‹œ
function showAddVehicleModal() {
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h2>ğŸš— ìƒˆ ì°¨ëŸ‰ ë“±ë¡</h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="vehicle-form">
          <div class="grid grid-2">
            <div class="form-group">
              <label for="plateNumber" class="form-label">ë²ˆí˜¸íŒ *</label>
              <input type="text" id="plateNumber" class="form-input" required>
            </div>
            <div class="form-group">
              <label for="make" class="form-label">ì œì¡°ì‚¬ *</label>
              <input type="text" id="make" class="form-input" required>
            </div>
            <div class="form-group">
              <label for="model" class="form-label">ëª¨ë¸ *</label>
              <input type="text" id="model" class="form-input" required>
            </div>
            <div class="form-group">
              <label for="year" class="form-label">ì—°ë„ *</label>
              <input type="number" id="year" class="form-input" min="1900" max="2030" required>
            </div>
            <div class="form-group">
              <label for="color" class="form-label">ìƒ‰ìƒ</label>
              <input type="text" id="color" class="form-input">
            </div>
            <div class="form-group">
              <label for="fuelType" class="form-label">ì—°ë£Œ íƒ€ì…</label>
              <select id="fuelType" class="form-input">
                <option value="Petrol">Petrol</option>
                <option value="Diesel">Diesel</option>
                <option value="Electric">Electric</option>
                <option value="Hybrid">Hybrid</option>
              </select>
            </div>
            <div class="form-group">
              <label for="regoExpiry" class="form-label">Rego ë§Œë£Œì¼</label>
              <input type="date" id="regoExpiry" class="form-input">
            </div>
            <div class="form-group">
              <label for="insuranceExpiry" class="form-label">ë³´í—˜ ë§Œë£Œì¼</label>
              <input type="date" id="insuranceExpiry" class="form-input">
            </div>
            <div class="form-group">
              <label for="greenSlipExpiry" class="form-label">Green Slip ë§Œë£Œì¼</label>
              <input type="date" id="greenSlipExpiry" class="form-input">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
        <button class="btn btn-primary" onclick="saveVehicle()">
          <span class="loading hidden"></span>
          ì €ì¥í•˜ê¸°
        </button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

// ì°¨ëŸ‰ ì €ì¥
async function saveVehicle() {
  const vehicleData = {
    plateNumber: document.getElementById('plateNumber').value,
    make: document.getElementById('make').value,
    model: document.getElementById('model').value,
    year: document.getElementById('year').value,
    color: document.getElementById('color').value,
    fuelType: document.getElementById('fuelType').value,
    regoExpiry: document.getElementById('regoExpiry').value,
    insuranceExpiry: document.getElementById('insuranceExpiry').value,
    greenSlipExpiry: document.getElementById('greenSlipExpiry').value
  };

  if (!vehicleData.plateNumber || !vehicleData.make || !vehicleData.model || !vehicleData.year) {
    showAlert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
    return;
  }

  const button = document.querySelector('.modal-footer .btn-primary');
  const loading = button.querySelector('.loading');
  
  button.disabled = true;
  loading.classList.remove('hidden');

  try {
    vehicleData.userId = currentUser.uid;
    vehicleData.createdAt = new Date().toISOString();
    vehicleData.id = crypto.randomUUID();

    const vehicleRef = ref(db, `vehicles/${currentUser.uid}/${vehicleData.id}`);
    await set(vehicleRef, vehicleData);
    
    showAlert('ì°¨ëŸ‰ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸš—', 'success');
    closeModal();
    loadVehicles();
  } catch (error) {
    console.error('ì°¨ëŸ‰ ì €ì¥ ì‹¤íŒ¨:', error);
    showAlert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
  } finally {
    button.disabled = false;
    loading.classList.add('hidden');
  }
}

// ì‚¬ê³  ê¸°ë¡ ì €ì¥
async function saveAccident(accidentData) {
  try {
    accidentData.userId = currentUser.uid;
    accidentData.createdAt = new Date().toISOString();
    accidentData.id = crypto.randomUUID();

    const accidentRef = ref(db, `accidents/${currentUser.uid}/${accidentData.id}`);
    await set(accidentRef, accidentData);
    
    showAlert('ì‚¬ê³  ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“', 'success');
    closeModal();
    loadAccidents();
  } catch (error) {
    console.error('ì‚¬ê³  ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨:', error);
    showAlert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
  }
}

// ì •ë¹„ ê¸°ë¡ ì €ì¥
async function saveMaintenance(maintenanceData) {
  try {
    maintenanceData.userId = currentUser.uid;
    maintenanceData.createdAt = new Date().toISOString();
    maintenanceData.id = crypto.randomUUID();

    const maintenanceRef = ref(db, `maintenance/${currentUser.uid}/${maintenanceData.id}`);
    await set(maintenanceRef, maintenanceData);
    
    showAlert('ì •ë¹„ ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ”§', 'success');
    closeModal();
    loadMaintenance();
  } catch (error) {
    console.error('ì •ë¹„ ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨:', error);
    showAlert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
  }
}

// ëŒ€ì‹œë³´ë“œ í†µê³„ ì—…ë°ì´íŠ¸
function updateDashboardStats() {
  const totalVehicles = vehicles.length;
  const expiringSoon = vehicles.filter(vehicle => {
    const today = new Date();
    const regoExpiry = vehicle.regoExpiry ? new Date(vehicle.regoExpiry) : null;
    const insuranceExpiry = vehicle.insuranceExpiry ? new Date(vehicle.insuranceExpiry) : null;
    const greenSlipExpiry = vehicle.greenSlipExpiry ? new Date(vehicle.greenSlipExpiry) : null;
    
    return (regoExpiry && regoExpiry - today <= 30 * 24 * 60 * 60 * 1000) ||
           (insuranceExpiry && insuranceExpiry - today <= 30 * 24 * 60 * 60 * 1000) ||
           (greenSlipExpiry && greenSlipExpiry - today <= 30 * 24 * 60 * 60 * 1000);
  }).length;

  // í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
  const statsContainer = document.getElementById('dashboard-stats');
  if (statsContainer) {
    statsContainer.innerHTML = `
      <div class="stats-card">
        <div class="stats-number">${totalVehicles}</div>
        <div class="stats-label">ë“±ë¡ëœ ì°¨ëŸ‰</div>
      </div>
      <div class="stats-card">
        <div class="stats-number">${expiringSoon}</div>
        <div class="stats-label">ë§Œë£Œ ì˜ˆì •</div>
      </div>
      <div class="stats-card">
        <div class="stats-number">${accidents.length}</div>
        <div class="stats-label">ì‚¬ê³  ê¸°ë¡</div>
      </div>
      <div class="stats-card">
        <div class="stats-number">${maintenance.length}</div>
        <div class="stats-label">ì •ë¹„ ê¸°ë¡</div>
      </div>
    `;
  }
}

// ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ
function showAlert(message, type = 'info') {
  const alert = document.createElement('div');
  alert.className = `alert alert-${type} fade-in`;
  alert.innerHTML = `
    <span>${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸'}</span>
    <span>${message}</span>
    <button onclick="this.parentElement.remove()" style="margin-left: auto; background: none; border: none; cursor: pointer;">&times;</button>
  `;
  
  // ê¸°ì¡´ ì•Œë¦¼ ì œê±°
  const existingAlerts = document.querySelectorAll('.alert');
  existingAlerts.forEach(alert => alert.remove());
  
  document.body.insertBefore(alert, document.body.firstChild);
  
  // 5ì´ˆ í›„ ìë™ ì œê±°
  setTimeout(() => {
    if (alert.parentElement) {
      alert.remove();
    }
  }, 5000);
}

// ëª¨ë‹¬ ë‹«ê¸°
function closeModal() {
  const modal = document.querySelector('.modal-overlay');
  if (modal) {
    modal.remove();
  }
}

// ëª¨ë°”ì¼ ë©”ë‰´ í† ê¸€
function toggleMobileMenu() {
  const nav = document.querySelector('.nav');
  nav.classList.toggle('mobile-nav-open');
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
  // Firebase ì´ˆê¸°í™”
  initializeFirebase();
  
  // ì¸ì¦ ìƒíƒœ í™•ì¸
  checkAuthStatus();
  
  // í˜„ì¬ í˜ì´ì§€ì— ë”°ë¥¸ ì´ˆê¸°í™”
  const currentPage = new URLSearchParams(window.location.search).get('page') || 'home';
  
  switch(currentPage) {
    case 'dashboard':
      loadVehicles();
      break;
    case 'vehicles':
      loadVehicles();
      break;
    case 'accidents':
      loadAccidents();
      break;
    case 'maintenance':
      loadMaintenance();
      break;
  }
  
  // ëª¨ë°”ì¼ ë©”ë‰´ ì´ë²¤íŠ¸
  const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
  if (mobileMenuBtn) {
    mobileMenuBtn.addEventListener('click', toggleMobileMenu);
  }
  
  // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal-overlay')) {
      closeModal();
    }
  });
});

// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
function formatDate(dateString) {
  if (!dateString) return '';
  const date = new Date(dateString);
  return date.toLocaleDateString('ko-KR');
}

function formatCurrency(amount) {
  return new Intl.NumberFormat('ko-KR', {
    style: 'currency',
    currency: 'AUD'
  }).format(amount);
}

// Firebase Storageë¥¼ ì‚¬ìš©í•œ ì´ë¯¸ì§€ ì—…ë¡œë“œ
async function handleImageUpload(file, callback) {
  try {
    const fileName = `${currentUser.uid}/${Date.now()}_${file.name}`;
    const imageRef = storageRef(storage, `images/${fileName}`);
    
    const snapshot = await uploadBytes(imageRef, file);
    const downloadURL = await getDownloadURL(snapshot.ref);
    
    callback(downloadURL);
  } catch (error) {
    console.error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
    // ì‹¤íŒ¨ì‹œ ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ fallback
    const reader = new FileReader();
    reader.onload = function(e) {
      callback(e.target.result);
    };
    reader.readAsDataURL(file);
  }
}

// Google ë¡œê·¸ì¸
async function signInWithGoogle() {
  try {
    const provider = new GoogleAuthProvider();
    const result = await signInWithPopup(auth, provider);
    console.log('Google ë¡œê·¸ì¸ ì„±ê³µ:', result.user);
  } catch (error) {
    console.error('Google ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
    showAlert('ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
  }
}

// ë¡œê·¸ì•„ì›ƒ
async function signOut() {
  try {
    await auth.signOut();
    console.log('ë¡œê·¸ì•„ì›ƒ ì„±ê³µ');
  } catch (error) {
    console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
  }
}

// ì‚¬ê³  ëª©ë¡ ë¡œë“œ
async function loadAccidents() {
  if (!currentUser) return;
  
  try {
    const accidentsRef = ref(db, `accidents/${currentUser.uid}`);
    const snapshot = await get(accidentsRef);
    
    if (snapshot.exists()) {
      accidents = Object.values(snapshot.val());
    } else {
      accidents = [];
    }
    
    renderAccidents();
  } catch (error) {
    console.error('ì‚¬ê³  ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
    showAlert('ì‚¬ê³  ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
  }
}

// ì •ë¹„ ëª©ë¡ ë¡œë“œ
async function loadMaintenance() {
  if (!currentUser) return;
  
  try {
    const maintenanceRef = ref(db, `maintenance/${currentUser.uid}`);
    const snapshot = await get(maintenanceRef);
    
    if (snapshot.exists()) {
      maintenance = Object.values(snapshot.val());
    } else {
      maintenance = [];
    }
    
    renderMaintenance();
  } catch (error) {
    console.error('ì •ë¹„ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
    showAlert('ì •ë¹„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
  }
}

// ì°¨ëŸ‰ ì‚­ì œ
async function deleteVehicle(vehicleId) {
  if (!confirm('ì •ë§ë¡œ ì´ ì°¨ëŸ‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  try {
    const vehicleRef = ref(db, `vehicles/${currentUser.uid}/${vehicleId}`);
    await remove(vehicleRef);
    
    showAlert('ì°¨ëŸ‰ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    loadVehicles();
  } catch (error) {
    console.error('ì°¨ëŸ‰ ì‚­ì œ ì‹¤íŒ¨:', error);
    showAlert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
  }
}

// ì°¨ëŸ‰ ìˆ˜ì •
async function editVehicle(vehicleId) {
  const vehicle = vehicles.find(v => v.id === vehicleId);
  if (!vehicle) return;
  
  // ìˆ˜ì • ëª¨ë‹¬ í‘œì‹œ (ê¸°ì¡´ ë“±ë¡ ëª¨ë‹¬ê³¼ ìœ ì‚¬)
  showEditVehicleModal(vehicle);
}

// ì‚¬ê³  ëª©ë¡ ë Œë”ë§
function renderAccidents() {
  const container = document.getElementById('accidents-container');
  if (!container) return;

  if (accidents.length === 0) {
    container.innerHTML = `
      <div class="card text-center">
        <div class="mb-4">ğŸ“</div>
        <h3>ë“±ë¡ëœ ì‚¬ê³  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</h3>
        <p class="text-gray-600 mb-4">ì‚¬ê³ ê°€ ë°œìƒí–ˆì„ ë•Œ ê¸°ë¡í•´ë³´ì„¸ìš”!</p>
        <button class="btn btn-primary" onclick="showAddAccidentModal()">
          ì‚¬ê³  ê¸°ë¡í•˜ê¸°
        </button>
      </div>
    `;
    return;
  }

  container.innerHTML = accidents.map(accident => `
    <div class="accident-card fade-in">
      <div class="accident-header">
        <h3>${accident.vehiclePlate} - ${formatDate(accident.accidentDate)}</h3>
        <span class="status-badge ${accident.status === 'ì²˜ë¦¬ì™„ë£Œ' ? 'status-ok' : 'status-warning'}">
          ${accident.status}
        </span>
      </div>
      <div class="accident-details">
        <p><strong>ì‚¬ê³  ìœ í˜•:</strong> ${accident.accidentType}</p>
        <p><strong>ì‚¬ê³  ì¥ì†Œ:</strong> ${accident.location}</p>
        <p><strong>ìƒëŒ€ë°©:</strong> ${accident.otherParty}</p>
        <p><strong>ë³´í—˜ì‚¬:</strong> ${accident.insurance}</p>
      </div>
    </div>
  `).join('');
}

// ì •ë¹„ ëª©ë¡ ë Œë”ë§
function renderMaintenance() {
  const container = document.getElementById('maintenance-container');
  if (!container) return;

  if (maintenance.length === 0) {
    container.innerHTML = `
      <div class="card text-center">
        <div class="mb-4">ğŸ”§</div>
        <h3>ë“±ë¡ëœ ì •ë¹„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</h3>
        <p class="text-gray-600 mb-4">ì •ë¹„ ì¼ì •ì„ ê´€ë¦¬í•´ë³´ì„¸ìš”!</p>
        <button class="btn btn-primary" onclick="showAddMaintenanceModal()">
          ì •ë¹„ ê¸°ë¡í•˜ê¸°
        </button>
      </div>
    `;
    return;
  }

  container.innerHTML = maintenance.map(item => `
    <div class="maintenance-card fade-in">
      <div class="maintenance-header">
        <h3>${item.vehiclePlate} - ${item.serviceType}</h3>
        <span class="status-badge ${item.status === 'ì™„ë£Œ' ? 'status-ok' : 'status-warning'}">
          ${item.status}
        </span>
      </div>
      <div class="maintenance-details">
        <p><strong>ì •ë¹„ì†Œ:</strong> ${item.garage}</p>
        <p><strong>ì •ë¹„ì¼:</strong> ${formatDate(item.serviceDate)}</p>
        <p><strong>ë¹„ìš©:</strong> ${formatCurrency(item.cost)}</p>
        <p><strong>ë‹¤ìŒ ì •ë¹„:</strong> ${formatDate(item.nextServiceDate)}</p>
      </div>
    </div>
  `).join('');
}

// ì§€ë„ ê´€ë ¨ í•¨ìˆ˜ (Google Maps API ì‚¬ìš©)
function initMap() {
  // Google Maps ì´ˆê¸°í™” ì½”ë“œ
  console.log('ì§€ë„ ì´ˆê¸°í™”ë¨');
}

// ìœ„ì¹˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
function getCurrentLocation(callback) {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      function(position) {
        callback({
          lat: position.coords.latitude,
          lng: position.coords.longitude
        });
      },
      function(error) {
        console.error('ìœ„ì¹˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
        callback(null);
      }
    );
  } else {
    console.error('Geolocationì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    callback(null);
  }
}
</script> 