<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JKCar Management - ì •ë¹„ê´€ë¦¬</title>
  <link rel="stylesheet" href="styles.css">
  <?!= include('styles'); ?>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="container">
      <div class="header-content">
        <a href="?page=home" class="logo">
          ğŸš— JKCar Management
        </a>
        <nav class="nav">
          <a href="?page=dashboard" class="nav-link">ğŸ“Š ëŒ€ì‹œë³´ë“œ</a>
          <a href="?page=vehicles" class="nav-link">ğŸš— ì°¨ëŸ‰ê´€ë¦¬</a>
          <a href="?page=accidents" class="nav-link">ğŸ“ ì‚¬ê³ ê´€ë¦¬</a>
          <a href="?page=maintenance" class="nav-link active">ğŸ”§ ì •ë¹„ê´€ë¦¬</a>
          <a href="?page=profile" class="nav-link">ğŸ‘¤ í”„ë¡œí•„</a>
        </nav>
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()">â˜°</button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main">
    <div class="container">
      <!-- Page Header -->
      <section class="page-header mb-6">
        <div class="card">
          <div class="page-header-content">
            <div class="page-header-text">
              <h1>ğŸ”§ ì •ë¹„ ê´€ë¦¬</h1>
              <p>ì •ë¹„ ì¼ì •ì„ ê´€ë¦¬í•˜ê³  ì •ë¹„ ë‚´ì—­ì„ ì²´ê³„ì ìœ¼ë¡œ ê¸°ë¡í•˜ì„¸ìš”.</p>
            </div>
            <div class="page-header-actions">
              <button class="btn btn-success" onclick="showAddMaintenanceModal()">
                ğŸ”§ ìƒˆ ì •ë¹„ ê¸°ë¡
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Maintenance Stats -->
      <section class="maintenance-stats mb-6">
        <div class="grid grid-4">
          <div class="stats-card">
            <div class="stats-number" id="total-maintenance">0</div>
            <div class="stats-label">ì´ ì •ë¹„ ê±´ìˆ˜</div>
          </div>
          <div class="stats-card">
            <div class="stats-number" id="this-year">0</div>
            <div class="stats-label">ì˜¬í•´ ì •ë¹„</div>
          </div>
          <div class="stats-card">
            <div class="stats-number" id="upcoming">0</div>
            <div class="stats-label">ì˜ˆì •ëœ ì •ë¹„</div>
          </div>
          <div class="stats-card">
            <div class="stats-number" id="total-cost">$0</div>
            <div class="stats-label">ì´ ì •ë¹„ ë¹„ìš©</div>
          </div>
        </div>
      </section>

      <!-- Quick Maintenance Actions -->
      <section class="quick-maintenance mb-6">
        <h2 class="section-title">âš¡ ë¹ ë¥¸ ì •ë¹„ ì‘ì—…</h2>
        <div class="grid grid-4">
          <div class="quick-action-card card text-center">
            <div class="quick-action-icon">ğŸ›¢ï¸</div>
            <h3>ì˜¤ì¼ êµí™˜</h3>
            <p>ì—”ì§„ ì˜¤ì¼ êµí™˜</p>
            <button class="btn btn-primary btn-sm" onclick="quickMaintenance('ì˜¤ì¼êµí™˜')">
              ê¸°ë¡í•˜ê¸°
            </button>
          </div>
          <div class="quick-action-card card text-center">
            <div class="quick-action-icon">ğŸ›</div>
            <h3>íƒ€ì´ì–´ êµì²´</h3>
            <p>íƒ€ì´ì–´ êµì²´/ì ê²€</p>
            <button class="btn btn-primary btn-sm" onclick="quickMaintenance('íƒ€ì´ì–´êµì²´')">
              ê¸°ë¡í•˜ê¸°
            </button>
          </div>
          <div class="quick-action-card card text-center">
            <div class="quick-action-icon">ğŸ›‘</div>
            <h3>ë¸Œë ˆì´í¬ ì ê²€</h3>
            <p>ë¸Œë ˆì´í¬ íŒ¨ë“œ ì ê²€</p>
            <button class="btn btn-primary btn-sm" onclick="quickMaintenance('ë¸Œë ˆì´í¬ì ê²€')">
              ê¸°ë¡í•˜ê¸°
            </button>
          </div>
          <div class="quick-action-card card text-center">
            <div class="quick-action-icon">ğŸ”‹</div>
            <h3>ë°°í„°ë¦¬ ì ê²€</h3>
            <p>ë°°í„°ë¦¬ ìƒíƒœ ì ê²€</p>
            <button class="btn btn-primary btn-sm" onclick="quickMaintenance('ë°°í„°ë¦¬ì ê²€')">
              ê¸°ë¡í•˜ê¸°
            </button>
          </div>
        </div>
      </section>

      <!-- Maintenance Schedule -->
      <section class="maintenance-schedule mb-6">
        <div class="card-header">
          <h2 class="section-title">ğŸ“… ì •ë¹„ ì¼ì •</h2>
          <div class="schedule-actions">
            <select id="filter-vehicle" class="form-input">
              <option value="">ëª¨ë“  ì°¨ëŸ‰</option>
              ${vehicles.map(v => `<option value="${v.plateNumber}">${v.plateNumber}</option>`).join('')}
            </select>
            <select id="filter-type" class="form-input">
              <option value="">ëª¨ë“  ìœ í˜•</option>
              <option value="ì˜¤ì¼êµí™˜">ì˜¤ì¼ êµí™˜</option>
              <option value="íƒ€ì´ì–´êµì²´">íƒ€ì´ì–´ êµì²´</option>
              <option value="ë¸Œë ˆì´í¬ì ê²€">ë¸Œë ˆì´í¬ ì ê²€</option>
              <option value="ë°°í„°ë¦¬ì ê²€">ë°°í„°ë¦¬ ì ê²€</option>
              <option value="ê¸°íƒ€">ê¸°íƒ€</option>
            </select>
          </div>
        </div>
        <div id="maintenance-schedule-container">
          <!-- ì •ë¹„ ì¼ì •ì´ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ -->
        </div>
      </section>

      <!-- Maintenance History -->
      <section class="maintenance-history">
        <h2 class="section-title">ğŸ“‹ ì •ë¹„ ì´ë ¥</h2>
        <div id="maintenance-container">
          <!-- ì •ë¹„ ì´ë ¥ì´ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ -->
        </div>
      </section>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <p>&copy; 2024 JKCar Management. All rights reserved.</p>
    </div>
  </footer>

  <?!= include('script'); ?>

  <script>
  // ì •ë¹„ ëª©ë¡ ë¡œë“œ
  function loadMaintenance() {
    google.script.run
      .withSuccessHandler(function(maintenanceList) {
        maintenance = maintenanceList;
        renderMaintenance();
        updateMaintenanceStats();
        renderMaintenanceSchedule();
      })
      .withFailureHandler(function(error) {
        console.error('ì •ë¹„ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        showAlert('ì •ë¹„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
      })
      .getMaintenance();
  }

  // ì •ë¹„ ëª©ë¡ ë Œë”ë§
  function renderMaintenance() {
    const container = document.getElementById('maintenance-container');
    if (!container) return;

    if (maintenance.length === 0) {
      container.innerHTML = `
        <div class="card text-center">
          <div class="mb-4">ğŸ”§</div>
          <h3>ë“±ë¡ëœ ì •ë¹„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</h3>
          <p class="text-gray-600 mb-4">ì²« ë²ˆì§¸ ì •ë¹„ ê¸°ë¡ì„ ë“±ë¡í•´ë³´ì„¸ìš”.</p>
          <button class="btn btn-success" onclick="showAddMaintenanceModal()">
            ì •ë¹„ ê¸°ë¡í•˜ê¸°
          </button>
        </div>
      `;
      return;
    }

    container.innerHTML = maintenance.map(m => `
      <div class="maintenance-card card mb-4">
        <div class="maintenance-header">
          <div class="maintenance-info">
            <h3>${m.vehiclePlate} - ${m.maintenanceType}</h3>
            <p class="maintenance-date">${formatDate(m.maintenanceDate)}</p>
          </div>
          <div class="maintenance-cost">
            <span class="cost-amount">$${m.cost || 0}</span>
          </div>
        </div>
        <div class="maintenance-details">
          <div class="detail-row">
            <span class="detail-label">ì •ë¹„ ìœ í˜•:</span>
            <span class="detail-value">${m.maintenanceType}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ì •ë¹„ì†Œ:</span>
            <span class="detail-value">${m.garageName || 'ì •ë³´ ì—†ìŒ'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ì£¼í–‰ê±°ë¦¬:</span>
            <span class="detail-value">${m.odometerReading ? m.odometerReading + 'km' : 'ì •ë³´ ì—†ìŒ'}</span>
          </div>
        </div>
        <div class="maintenance-actions">
          <button class="btn btn-sm btn-primary" onclick="viewMaintenanceDetails('${m.id}')">
            ğŸ‘ï¸ ìƒì„¸ë³´ê¸°
          </button>
          <button class="btn btn-sm btn-secondary" onclick="editMaintenance('${m.id}')">
            âœï¸ ìˆ˜ì •
          </button>
          <button class="btn btn-sm btn-error" onclick="deleteMaintenance('${m.id}')">
            ğŸ—‘ï¸ ì‚­ì œ
          </button>
        </div>
      </div>
    `).join('');
  }

  // ì •ë¹„ í†µê³„ ì—…ë°ì´íŠ¸
  function updateMaintenanceStats() {
    const total = maintenance.length;
    const thisYear = maintenance.filter(m => {
      const maintenanceYear = new Date(m.maintenanceDate).getFullYear();
      return maintenanceYear === new Date().getFullYear();
    }).length;
    const upcoming = maintenance.filter(m => {
      const nextDate = m.nextMaintenanceDate;
      if (!nextDate) return false;
      const next = new Date(nextDate);
      const today = new Date();
      return next > today && next - today <= 30 * 24 * 60 * 60 * 1000;
    }).length;
    const totalCost = maintenance.reduce((sum, m) => sum + (parseFloat(m.cost) || 0), 0);

    document.getElementById('total-maintenance').textContent = total;
    document.getElementById('this-year').textContent = thisYear;
    document.getElementById('upcoming').textContent = upcoming;
    document.getElementById('total-cost').textContent = `$${totalCost.toFixed(0)}`;
  }

  // ì •ë¹„ ì¼ì • ë Œë”ë§
  function renderMaintenanceSchedule() {
    const container = document.getElementById('maintenance-schedule-container');
    if (!container) return;

    const upcomingMaintenance = maintenance.filter(m => {
      const nextDate = m.nextMaintenanceDate;
      if (!nextDate) return false;
      const next = new Date(nextDate);
      const today = new Date();
      return next > today;
    }).sort((a, b) => new Date(a.nextMaintenanceDate) - new Date(b.nextMaintenanceDate));

    if (upcomingMaintenance.length === 0) {
      container.innerHTML = `
        <div class="card text-center">
          <div class="mb-4">âœ…</div>
          <h3>ì˜ˆì •ëœ ì •ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
          <p class="text-gray-600">ëª¨ë“  ì •ë¹„ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</p>
        </div>
      `;
      return;
    }

    container.innerHTML = upcomingMaintenance.map(m => {
      const nextDate = new Date(m.nextMaintenanceDate);
      const today = new Date();
      const daysUntil = Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24));
      
      let urgencyClass = 'status-ok';
      if (daysUntil <= 7) urgencyClass = 'status-error';
      else if (daysUntil <= 30) urgencyClass = 'status-warning';

      return `
        <div class="schedule-card card mb-3">
          <div class="schedule-content">
            <div class="schedule-info">
              <div class="schedule-title">${m.vehiclePlate} - ${m.maintenanceType}</div>
              <div class="schedule-date">${formatDate(m.nextMaintenanceDate)} (${daysUntil}ì¼ í›„)</div>
            </div>
            <div class="schedule-status">
              <span class="status-badge ${urgencyClass}">
                ${daysUntil <= 7 ? 'ê¸´ê¸‰' : daysUntil <= 30 ? 'ì˜ˆì •' : 'ì •ìƒ'}
              </span>
            </div>
            <div class="schedule-actions">
              <button class="btn btn-sm btn-success" onclick="markMaintenanceComplete('${m.id}')">
                ì™„ë£Œ
              </button>
              <button class="btn btn-sm btn-secondary" onclick="rescheduleMaintenance('${m.id}')">
                ì—°ê¸°
              </button>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  // ë¹ ë¥¸ ì •ë¹„ ê¸°ë¡
  function quickMaintenance(type) {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
      <div class="modal-content">
        <div class="modal-header">
          <h2>ğŸ”§ ${type} ê¸°ë¡</h2>
          <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
          <form id="quick-maintenance-form">
            <div class="form-group">
              <label for="quick-vehicle" class="form-label">ì°¨ëŸ‰ ì„ íƒ *</label>
              <select id="quick-vehicle" class="form-input" required>
                <option value="">ì°¨ëŸ‰ ì„ íƒ</option>
                ${vehicles.map(v => `<option value="${v.plateNumber}">${v.plateNumber} - ${v.make} ${v.model}</option>`).join('')}
              </select>
            </div>
            <div class="form-group">
              <label for="quick-date" class="form-label">ì •ë¹„ ë‚ ì§œ *</label>
              <input type="date" id="quick-date" class="form-input" required>
            </div>
            <div class="form-group">
              <label for="quick-cost" class="form-label">ì •ë¹„ ë¹„ìš©</label>
              <input type="number" id="quick-cost" class="form-input" placeholder="0" min="0" step="0.01">
            </div>
            <div class="form-group">
              <label for="quick-notes" class="form-label">ë©”ëª¨</label>
              <textarea id="quick-notes" class="form-textarea" placeholder="ì •ë¹„ ë‚´ìš©ì„ ê°„ë‹¨íˆ ê¸°ë¡í•˜ì„¸ìš”..."></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button class="btn btn-success" onclick="saveQuickMaintenance('${type}')">
            <span class="loading hidden"></span>
            ì €ì¥í•˜ê¸°
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }

  // ë¹ ë¥¸ ì •ë¹„ ì €ì¥
  function saveQuickMaintenance(type) {
    const maintenanceData = {
      vehiclePlate: document.getElementById('quick-vehicle').value,
      maintenanceType: type,
      maintenanceDate: document.getElementById('quick-date').value,
      cost: document.getElementById('quick-cost').value,
      notes: document.getElementById('quick-notes').value,
      status: 'completed'
    };

    if (!maintenanceData.vehiclePlate || !maintenanceData.maintenanceDate) {
      showAlert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
      return;
    }

    const button = document.querySelector('.modal-footer .btn-success');
    const loading = button.querySelector('.loading');
    
    button.disabled = true;
    loading.classList.remove('hidden');

    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          showAlert('ì •ë¹„ ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ”§', 'success');
          closeModal();
          loadMaintenance();
        } else {
          showAlert(result.message, 'error');
        }
      })
      .withFailureHandler(function(error) {
        showAlert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
      })
      .withFinally(function() {
        button.disabled = false;
        loading.classList.add('hidden');
      })
      .saveMaintenance(maintenanceData);
  }

  // ìƒˆ ì •ë¹„ ê¸°ë¡ ëª¨ë‹¬ í‘œì‹œ
  function showAddMaintenanceModal() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
      <div class="modal-content modal-large">
        <div class="modal-header">
          <h2>ğŸ”§ ìƒˆ ì •ë¹„ ê¸°ë¡</h2>
          <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
          <form id="maintenance-form">
            <div class="form-section">
              <h3>ğŸš— ì°¨ëŸ‰ ì •ë³´</h3>
              <div class="grid grid-2">
                <div class="form-group">
                  <label for="vehiclePlate" class="form-label">ì°¨ëŸ‰ ë²ˆí˜¸íŒ *</label>
                  <select id="vehiclePlate" class="form-input" required>
                    <option value="">ì°¨ëŸ‰ ì„ íƒ</option>
                    ${vehicles.map(v => `<option value="${v.plateNumber}">${v.plateNumber} - ${v.make} ${v.model}</option>`).join('')}
                  </select>
                </div>
                <div class="form-group">
                  <label for="maintenanceDate" class="form-label">ì •ë¹„ ë‚ ì§œ *</label>
                  <input type="date" id="maintenanceDate" class="form-input" required>
                </div>
              </div>
            </div>

            <div class="form-section">
              <h3>ğŸ”§ ì •ë¹„ ì •ë³´</h3>
              <div class="grid grid-2">
                <div class="form-group">
                  <label for="maintenanceType" class="form-label">ì •ë¹„ ìœ í˜• *</label>
                  <select id="maintenanceType" class="form-input" required>
                    <option value="">ì •ë¹„ ìœ í˜• ì„ íƒ</option>
                    <option value="ì˜¤ì¼êµí™˜">ì˜¤ì¼ êµí™˜</option>
                    <option value="íƒ€ì´ì–´êµì²´">íƒ€ì´ì–´ êµì²´</option>
                    <option value="ë¸Œë ˆì´í¬ì ê²€">ë¸Œë ˆì´í¬ ì ê²€</option>
                    <option value="ë°°í„°ë¦¬ì ê²€">ë°°í„°ë¦¬ ì ê²€</option>
                    <option value="ì—ì–´ì»¨ì ê²€">ì—ì–´ì»¨ ì ê²€</option>
                    <option value="ì •ê¸°ì ê²€">ì •ê¸° ì ê²€</option>
                    <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="cost" class="form-label">ì •ë¹„ ë¹„ìš©</label>
                  <input type="number" id="cost" class="form-input" placeholder="0" min="0" step="0.01">
                </div>
                <div class="form-group">
                  <label for="odometerReading" class="form-label">ì£¼í–‰ê±°ë¦¬ (km)</label>
                  <input type="number" id="odometerReading" class="form-input" placeholder="0" min="0">
                </div>
                <div class="form-group">
                  <label for="nextMaintenanceDate" class="form-label">ë‹¤ìŒ ì •ë¹„ ì˜ˆì •ì¼</label>
                  <input type="date" id="nextMaintenanceDate" class="form-input">
                </div>
              </div>
              <div class="form-group">
                <label for="description" class="form-label">ì •ë¹„ ìƒì„¸ ë‚´ìš©</label>
                <textarea id="description" class="form-textarea" placeholder="ì •ë¹„ ë‚´ìš©ì„ ìì„¸íˆ ê¸°ë¡í•˜ì„¸ìš”..."></textarea>
              </div>
            </div>

            <div class="form-section">
              <h3>ğŸ¢ ì •ë¹„ì†Œ ì •ë³´</h3>
              <div class="grid grid-2">
                <div class="form-group">
                  <label for="garageName" class="form-label">ì •ë¹„ì†Œëª…</label>
                  <input type="text" id="garageName" class="form-input" placeholder="ì •ë¹„ì†Œ ì´ë¦„">
                </div>
                <div class="form-group">
                  <label for="garagePhone" class="form-label">ì •ë¹„ì†Œ ì—°ë½ì²˜</label>
                  <input type="tel" id="garagePhone" class="form-input" placeholder="ì „í™”ë²ˆí˜¸">
                </div>
                <div class="form-group">
                  <label for="garageAddress" class="form-label">ì •ë¹„ì†Œ ì£¼ì†Œ</label>
                  <input type="text" id="garageAddress" class="form-input" placeholder="ì£¼ì†Œ">
                </div>
                <div class="form-group">
                  <label for="mechanicName" class="form-label">ì •ë¹„ì‚¬ ì´ë¦„</label>
                  <input type="text" id="mechanicName" class="form-input" placeholder="ì •ë¹„ì‚¬ ì´ë¦„">
                </div>
              </div>
            </div>

            <div class="form-section">
              <h3>ğŸ“¸ ì‚¬ì§„ ì—…ë¡œë“œ</h3>
              <div class="photo-upload-grid">
                <div class="photo-upload-item">
                  <label for="beforePhoto" class="photo-upload-label">
                    <div class="photo-upload-box">
                      <span>ğŸ“·</span>
                      <p>ì •ë¹„ ì „ ì‚¬ì§„</p>
                    </div>
                  </label>
                  <input type="file" id="beforePhoto" class="photo-upload-input" accept="image/*" onchange="previewImage(this, 'beforePreview')">
                  <div id="beforePreview" class="photo-preview"></div>
                </div>
                <div class="photo-upload-item">
                  <label for="afterPhoto" class="photo-upload-label">
                    <div class="photo-upload-box">
                      <span>ğŸ“¸</span>
                      <p>ì •ë¹„ í›„ ì‚¬ì§„</p>
                    </div>
                  </label>
                  <input type="file" id="afterPhoto" class="photo-upload-input" accept="image/*" onchange="previewImage(this, 'afterPreview')">
                  <div id="afterPreview" class="photo-preview"></div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button class="btn btn-success" onclick="saveMaintenance()">
            <span class="loading hidden"></span>
            ì •ë¹„ ê¸°ë¡ ì €ì¥
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }

  // ì •ë¹„ ê¸°ë¡ ì €ì¥
  function saveMaintenance() {
    const maintenanceData = {
      vehiclePlate: document.getElementById('vehiclePlate').value,
      maintenanceDate: document.getElementById('maintenanceDate').value,
      maintenanceType: document.getElementById('maintenanceType').value,
      cost: document.getElementById('cost').value,
      odometerReading: document.getElementById('odometerReading').value,
      nextMaintenanceDate: document.getElementById('nextMaintenanceDate').value,
      description: document.getElementById('description').value,
      garageName: document.getElementById('garageName').value,
      garagePhone: document.getElementById('garagePhone').value,
      garageAddress: document.getElementById('garageAddress').value,
      mechanicName: document.getElementById('mechanicName').value,
      status: 'completed',
      photos: {
        before: document.getElementById('beforePhoto').files[0],
        after: document.getElementById('afterPhoto').files[0]
      }
    };

    if (!maintenanceData.vehiclePlate || !maintenanceData.maintenanceDate || !maintenanceData.maintenanceType) {
      showAlert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
      return;
    }

    const button = document.querySelector('.modal-footer .btn-success');
    const loading = button.querySelector('.loading');
    
    button.disabled = true;
    loading.classList.remove('hidden');

    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          showAlert('ì •ë¹„ ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ”§', 'success');
          closeModal();
          loadMaintenance();
        } else {
          showAlert(result.message, 'error');
        }
      })
      .withFailureHandler(function(error) {
        showAlert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
      })
      .withFinally(function() {
        button.disabled = false;
        loading.classList.add('hidden');
      })
      .saveMaintenance(maintenanceData);
  }

  // ì •ë¹„ ì™„ë£Œ í‘œì‹œ
  function markMaintenanceComplete(maintenanceId) {
    if (confirm('ì´ ì •ë¹„ë¥¼ ì™„ë£Œë¡œ í‘œì‹œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showAlert('ì •ë¹„ê°€ ì™„ë£Œë¡œ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            loadMaintenance();
          } else {
            showAlert(result.message, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showAlert('ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        })
        .markMaintenanceComplete(maintenanceId);
    }
  }

  // ì •ë¹„ ì¼ì • ì—°ê¸°
  function rescheduleMaintenance(maintenanceId) {
    const newDate = prompt('ìƒˆë¡œìš´ ì •ë¹„ ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš” (YYYY-MM-DD):');
    if (newDate) {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showAlert('ì •ë¹„ ì¼ì •ì´ ì—°ê¸°ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            loadMaintenance();
          } else {
            showAlert(result.message, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showAlert('ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        })
        .rescheduleMaintenance(maintenanceId, newDate);
    }
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì •ë¹„ ëª©ë¡ ë¡œë“œ
  document.addEventListener('DOMContentLoaded', function() {
    loadMaintenance();
  });
  </script>

  <style>
  /* Maintenance Cards */
  .maintenance-card {
    border-left: 4px solid var(--success);
  }

  .maintenance-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
  }

  .maintenance-info h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--gray-800);
    margin-bottom: 0.25rem;
  }

  .maintenance-date {
    color: var(--gray-600);
    font-size: 0.875rem;
  }

  .maintenance-cost {
    text-align: right;
  }

  .cost-amount {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--success);
  }

  .maintenance-details {
    margin-bottom: 1rem;
  }

  .maintenance-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  /* Schedule Cards */
  .schedule-card {
    border-left: 4px solid var(--warning);
  }

  .schedule-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
  }

  .schedule-title {
    font-weight: 600;
    color: var(--gray-800);
    margin-bottom: 0.25rem;
  }

  .schedule-date {
    color: var(--gray-600);
    font-size: 0.875rem;
  }

  .schedule-actions {
    display: flex;
    gap: 0.5rem;
  }

  /* Quick Action Cards */
  .quick-action-card {
    padding: 2rem 1.5rem;
  }

  .quick-action-icon {
    font-size: 2.5rem;
    margin-bottom: 1rem;
  }

  .quick-action-card h3 {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--gray-800);
  }

  .quick-action-card p {
    color: var(--gray-600);
    margin-bottom: 1rem;
    font-size: 0.875rem;
  }

  /* Schedule Actions */
  .schedule-actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .maintenance-header {
      flex-direction: column;
      gap: 1rem;
    }

    .maintenance-actions {
      justify-content: center;
    }

    .schedule-content {
      flex-direction: column;
      text-align: center;
      gap: 1rem;
    }

    .schedule-actions {
      justify-content: center;
    }

    .quick-action-card {
      padding: 1.5rem 1rem;
    }
  }
  </style>
</body>
</html> 